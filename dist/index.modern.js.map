{"version":3,"file":"index.modern.js","sources":["../src/hooks/useForceUpdate.ts","../src/utils/subject.ts","../src/utils/create-context-selector.tsx"],"sourcesContent":["import { useState, useCallback, useRef, useEffect, useMemo } from 'react'\nconst useForceUpdate = () => {\n  const [io, setIO] = useState(true)\n  const ioRef = useRef(io)\n  useEffect(() => {\n    ioRef.current = io\n  })\n  const forceUpdate = useCallback(() => setIO(!ioRef.current), [])\n  const state = useMemo(() => forceUpdate, [forceUpdate])\n  return state\n}\n\nexport default useForceUpdate\n","import createSubject, { Subject as SJ } from 'rx-subject'\n\nexport class Subject<T = any> {\n  private subject: SJ<T>\n  constructor() {\n    this.subject = createSubject<T>()\n  }\n\n  next(value: T) {\n    this.subject.sink.next(value)\n  }\n\n  subscribe(subscriber: (value: T) => void) {\n    return this.subject.source$.subscribe(subscriber)\n  }\n}\n","import React, {\n  useEffect,\n  useContext,\n  useState,\n  useRef,\n  useCallback\n} from 'react'\nimport produce from 'immer'\nimport { shallowEqual } from 'shallow-utils'\nimport { useForceUpdate } from '../hooks'\nimport { Subject } from './subject'\n\nexport const createContextSelector = <T extends any = any>(\n  ctx: React.Context<T>\n) => {\n  let getState = () => (null as any) as T\n  const dispatcher = new Subject()\n  let wrapperMounted = false\n  const useContextSelector = <Selector extends (state: T) => any>(\n    selector: Selector\n  ) => {\n    const [initialState] = useState(() => {\n      if (!wrapperMounted) {\n        throw new Error(\n          'the HookWrapper component should be mounted directly under the context provider'\n        )\n      }\n      return selector(getState()) as T\n    })\n    const selectorRef = useRef(selector)\n    selectorRef.current = selector\n    const stateRef = useRef({ value: initialState })\n\n    const checkUpdate = useCallback((ctxState?: T) => {\n      const newState = selectorRef.current(ctxState || getState())\n      const isEqual = shallowEqual(\n        { value: newState },\n        { value: stateRef.current.value }\n      )\n      if (isEqual) {\n        return false\n      }\n      stateRef.current = { value: produce(newState, () => {}) as any }\n      return true\n    }, [])\n    const shouldCheckEqualityInComponent = useRef(false)\n\n    if (shouldCheckEqualityInComponent.current) {\n      // when the component itself re-renders but not because of a context update\n      checkUpdate()\n    } else {\n      shouldCheckEqualityInComponent.current = true\n    }\n\n    const forceUpdate = useForceUpdate()\n    useEffect(() => {\n      const doUpdate = () => {\n        if (!wrapperMounted) return\n        const shouldUpdate = checkUpdate()\n        if (shouldUpdate) {\n          // we already check the shallow equal here\n          shouldCheckEqualityInComponent.current = false\n          forceUpdate()\n        }\n      }\n      const subscription = dispatcher.subscribe(doUpdate)\n      doUpdate() // first update\n      return () => {\n        subscription.unsubscribe()\n      }\n    }, [])\n    return stateRef.current.value as ReturnType<Selector>\n  }\n\n  const Cleanner = React.memo(() => {\n    const ctxState = useContext(ctx)\n    getState = () => ctxState\n    wrapperMounted = true\n    useEffect(() => {\n      dispatcher.next(ctxState)\n    })\n    useEffect(() => {\n      return () => {\n        wrapperMounted = false\n      }\n    }, [])\n    return null\n  })\n\n  return [Cleanner, useContextSelector] as [\n    typeof Cleanner,\n    typeof useContextSelector\n  ]\n}\n"],"names":["useForceUpdate","useState","io","setIO","ioRef","useRef","useEffect","current","forceUpdate","useCallback","state","useMemo","Subject","subject","createSubject","next","value","sink","subscribe","subscriber","source$","createContextSelector","ctx","getState","dispatcher","wrapperMounted","useContextSelector","selector","Error","initialState","selectorRef","stateRef","checkUpdate","ctxState","newState","isEqual","shallowEqual","produce","shouldCheckEqualityInComponent","doUpdate","shouldUpdate","subscription","unsubscribe","Cleanner","React","memo","useContext"],"mappings":";;;;;AACA,IAAMA,cAAc,GAAG,SAAjBA,cAAiB;kBACDC,QAAQ,CAAC,IAAD;MAArBC;MAAIC;;AACX,MAAMC,KAAK,GAAGC,MAAM,CAACH,EAAD,CAApB;AACAI,EAAAA,SAAS,CAAC;AACRF,IAAAA,KAAK,CAACG,OAAN,GAAgBL,EAAhB;AACD,GAFQ,CAAT;AAGA,MAAMM,WAAW,GAAGC,WAAW,CAAC;AAAA,WAAMN,KAAK,CAAC,CAACC,KAAK,CAACG,OAAR,CAAX;AAAA,GAAD,EAA8B,EAA9B,CAA/B;AACA,MAAMG,KAAK,GAAGC,OAAO,CAAC;AAAA,WAAMH,WAAN;AAAA,GAAD,EAAoB,CAACA,WAAD,CAApB,CAArB;AACA,SAAOE,KAAP;AACD,CATD;;ICCaE,OAAb;AAEE;AACE,SAAKC,OAAL,GAAeC,aAAa,EAA5B;AACD;;AAJH;;AAAA,SAMEC,IANF,GAME,cAAKC,KAAL;AACE,SAAKH,OAAL,CAAaI,IAAb,CAAkBF,IAAlB,CAAuBC,KAAvB;AACD,GARH;;AAAA,SAUEE,SAVF,GAUE,mBAAUC,UAAV;AACE,WAAO,KAAKN,OAAL,CAAaO,OAAb,CAAqBF,SAArB,CAA+BC,UAA/B,CAAP;AACD,GAZH;;AAAA;AAAA;;ICUaE,qBAAqB,GAAG,SAAxBA,qBAAwB,CACnCC,GADmC;AAGnC,MAAIC,QAAQ,GAAG;AAAA,WAAO,IAAP;AAAA,GAAf;;AACA,MAAMC,UAAU,GAAG,IAAIZ,OAAJ,EAAnB;AACA,MAAIa,cAAc,GAAG,KAArB;;AACA,MAAMC,kBAAkB,GAAG,SAArBA,kBAAqB,CACzBC,QADyB;oBAGF1B,QAAQ,CAAC;AAC9B,UAAI,CAACwB,cAAL,EAAqB;AACnB,cAAM,IAAIG,KAAJ,CACJ,iFADI,CAAN;AAGD;;AACD,aAAOD,QAAQ,CAACJ,QAAQ,EAAT,CAAf;AACD,KAP8B;QAAxBM;;AAQP,QAAMC,WAAW,GAAGzB,MAAM,CAACsB,QAAD,CAA1B;AACAG,IAAAA,WAAW,CAACvB,OAAZ,GAAsBoB,QAAtB;AACA,QAAMI,QAAQ,GAAG1B,MAAM,CAAC;AAAEW,MAAAA,KAAK,EAAEa;AAAT,KAAD,CAAvB;AAEA,QAAMG,WAAW,GAAGvB,WAAW,CAAC,UAACwB,QAAD;AAC9B,UAAMC,QAAQ,GAAGJ,WAAW,CAACvB,OAAZ,CAAoB0B,QAAQ,IAAIV,QAAQ,EAAxC,CAAjB;AACA,UAAMY,OAAO,GAAGC,YAAY,CAC1B;AAAEpB,QAAAA,KAAK,EAAEkB;AAAT,OAD0B,EAE1B;AAAElB,QAAAA,KAAK,EAAEe,QAAQ,CAACxB,OAAT,CAAiBS;AAA1B,OAF0B,CAA5B;;AAIA,UAAImB,OAAJ,EAAa;AACX,eAAO,KAAP;AACD;;AACDJ,MAAAA,QAAQ,CAACxB,OAAT,GAAmB;AAAES,QAAAA,KAAK,EAAEqB,OAAO,CAACH,QAAD,EAAW,cAAX;AAAhB,OAAnB;AACA,aAAO,IAAP;AACD,KAX8B,EAW5B,EAX4B,CAA/B;AAYA,QAAMI,8BAA8B,GAAGjC,MAAM,CAAC,KAAD,CAA7C;;AAEA,QAAIiC,8BAA8B,CAAC/B,OAAnC,EAA4C;AAE1CyB,MAAAA,WAAW;AACZ,KAHD,MAGO;AACLM,MAAAA,8BAA8B,CAAC/B,OAA/B,GAAyC,IAAzC;AACD;;AAED,QAAMC,WAAW,GAAGR,cAAc,EAAlC;AACAM,IAAAA,SAAS,CAAC;AACR,UAAMiC,QAAQ,GAAG,SAAXA,QAAW;AACf,YAAI,CAACd,cAAL,EAAqB;AACrB,YAAMe,YAAY,GAAGR,WAAW,EAAhC;;AACA,YAAIQ,YAAJ,EAAkB;AAEhBF,UAAAA,8BAA8B,CAAC/B,OAA/B,GAAyC,KAAzC;AACAC,UAAAA,WAAW;AACZ;AACF,OARD;;AASA,UAAMiC,YAAY,GAAGjB,UAAU,CAACN,SAAX,CAAqBqB,QAArB,CAArB;AACAA,MAAAA,QAAQ;AACR,aAAO;AACLE,QAAAA,YAAY,CAACC,WAAb;AACD,OAFD;AAGD,KAfQ,EAeN,EAfM,CAAT;AAgBA,WAAOX,QAAQ,CAACxB,OAAT,CAAiBS,KAAxB;AACD,GAtDD;;AAwDA,MAAM2B,QAAQ,GAAGC,KAAK,CAACC,IAAN,CAAW;AAC1B,QAAMZ,QAAQ,GAAGa,UAAU,CAACxB,GAAD,CAA3B;;AACAC,IAAAA,QAAQ,GAAG;AAAA,aAAMU,QAAN;AAAA,KAAX;;AACAR,IAAAA,cAAc,GAAG,IAAjB;AACAnB,IAAAA,SAAS,CAAC;AACRkB,MAAAA,UAAU,CAACT,IAAX,CAAgBkB,QAAhB;AACD,KAFQ,CAAT;AAGA3B,IAAAA,SAAS,CAAC;AACR,aAAO;AACLmB,QAAAA,cAAc,GAAG,KAAjB;AACD,OAFD;AAGD,KAJQ,EAIN,EAJM,CAAT;AAKA,WAAO,IAAP;AACD,GAbgB,CAAjB;AAeA,SAAO,CAACkB,QAAD,EAAWjB,kBAAX,CAAP;AAID,CAjFM;;;;"}